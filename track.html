<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Work Orders Dashboard (Supabase)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Added Chart.js library for graphs -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- 
      NEW: Added Supabase JS Client
      Get this from your Supabase project's API settings
    -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* Transitions for modals and cards */
        .modal { transition: opacity 0.2s ease-in-out, visibility 0.2s ease-in-out; }
        .card-item { transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out; }
        .card-item:hover { transform: translateY(-4px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
        .progress-bar { transition: width 0.3s ease-in-out; }
        .filter-btn { transition: background-color 0.2s, color 0.2s; }
        /* Ensuring good mobile view padding */
        .stat-card {
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
        }
        /* Cursors for new clickable stats */
        .stat-clickable {
            cursor: pointer;
            transition: background-color 0.2s ease-in-out;
        }
        .stat-clickable:hover {
            background-color: rgba(0, 0, 0, 0.03);
        }
        .stat-default {
            cursor: default;
        }
        /* Scrollbar for upcoming list */
        .upcoming-list::-webkit-scrollbar {
            width: 6px;
        }
        .upcoming-list::-webkit-scrollbar-thumb {
            background-color: #cbd5e1; /* gray-300 */
            border-radius: 3px;
        }
        .upcoming-list::-webkit-scrollbar-track {
            background-color: #f1f5f9; /* gray-100 */
        }
        /* NEW: Image gallery styles */
        .gallery-image-container {
            position: relative;
        }
        .gallery-delete-btn {
            position: absolute;
            top: 4px;
            right: 4px;
            background-color: rgba(0, 0, 0, 0.6);
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            font-size: 12px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
            opacity: 0.8;
            transition: opacity 0.2s;
        }
        .gallery-delete-btn:hover {
            opacity: 1;
        }
    </style>
</head>

<body class="bg-gray-100 font-sans">
    <header class="bg-gray-800 text-white p-4 shadow-md sticky top-0 z-20">
        <h1 class="text-xl font-bold text-center">Work Orders Dashboard (Supabase)</h1>
    </header>

    <!-- Main Content Container (Increased max-width for the sidebar) -->
    <div class="p-4 max-w-7xl mx-auto">
        
        <!-- Start of responsive two-column layout -->
        <div class="flex flex-col lg:flex-row gap-6">

            <!-- 1. Main Content Area (Work Orders List) - Takes 2/3 on large screens -->
            <div class="lg:w-2/3">
                
                <!-- Error Message Box -->
                <div id="error-message" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg my-4" role="alert">
                    <div class="flex">
                        <div class="py-1"><svg class="fill-current h-6 w-6 text-red-500 mr-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M10 0a10 10 0 1 0 10 10A10 10 0 0 0 10 0zm0 18a8 8 0 1 1 8-8 8 8 0 0 1-8 8zm-1-4a1 1 0 0 1-2 0V7a1 1 0 1 1 2 0v7zm1-9a1 1 0 1 1 0 2 1 1 0 0 1 0-2z"/></svg></div>
                        <div>
                            <strong class="font-bold">Error:</strong>
                            <span id="error-text" class="block sm:inline"></span>
                        </div>
                        <button type="button" class="ml-auto -mx-1.5 -my-1.5 bg-red-100 text-red-500 rounded-lg p-1.5 inline-flex h-8 w-8" onclick="showError(null)">
                            <span class="sr-only">Close</span>
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg>
                        </button>
                    </div>
                </div>
            
                <!-- Search & Sort -->
                <div class="flex flex-col sm:flex-row sm:justify-between gap-2 mb-4">
                    <input id="search" placeholder="Search Work No or Company..." class="border rounded-lg px-3 py-2 w-full sm:w-1/2 shadow-sm">
                    <select id="sort" class="border rounded-lg px-3 py-2 w-full sm:w-1/3 bg-white shadow-sm">
                        <option value="">Sort by (Default: Work No ↓)</option>
                        <option value="workno-asc">Work No ↑</option>
                        <option value="workno-desc">Work No ↓</option>
                        <option value="delivery-asc">Delivery ↑</option>
                        <option value="delivery-desc">Delivery ↓</option>
                        <option value="qty-asc">Qty ↑</option>
                        <option value="qty-desc">Qty ↓</option>
                    </select>
                </div>

                <!-- Status Filters -->
                <div class="flex flex-wrap gap-2 mb-4" id="statusFilters"></div>

                <!-- Add Button -->
                <button onclick="openAddModal()" class="bg-indigo-600 text-white px-4 py-2 rounded-lg mb-4 hover:bg-indigo-700 shadow focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-opacity-50">
                    ➕ Add Work Order
                </button>

                <div id="loader" class="text-center py-6 text-gray-600">Loading...</div>
                <div id="cards" class="space-y-3"></div>

            </div>

            <!-- 2. Statistics Sidebar - Takes 1/3 on large screens -->
            <div class="lg:w-1/3 space-y-6" id="stats-sidebar">
                
                <!-- Stat Card 1: Order Summary -->
                <div class="bg-white p-5 rounded-xl shadow-lg border-t-4 border-indigo-500">
                    <h2 class="text-lg font-bold text-gray-800 mb-4 border-b pb-2">Order Summary</h2>
                    <!-- UPDATED to grid-cols-3 to fit new 'Cancelled' card -->
                    <div class="grid grid-cols-3 gap-4" id="stats-section-1-content">
                        <!-- Stats 1 content goes here -->
                    </div>
                </div>

                <!-- Stat Card 2: Quantity Metrics -->
                <div class="bg-white p-5 rounded-xl shadow-lg border-t-4 border-gray-500">
                    <h2 class="text-lg font-bold text-gray-800 mb-4 border-b pb-2">Quantity Metrics</h2>
                    <div class="space-y-4" id="stats-section-2-content">
                        <!-- Stats 2 content goes here -->
                    </div>
                </div>

                <!-- NEW: Upcoming Orders List -->
                <div class="bg-white p-5 rounded-xl shadow-lg border-t-4 border-orange-500">
                    <h2 class="text-lg font-bold text-gray-800 mb-4 border-b pb-2">Upcoming Orders</h2>
                    <div class="space-y-3 max-h-72 overflow-y-auto upcoming-list pr-2" id="upcoming-orders-list">
                        <!-- Upcoming orders will be injected here by JS -->
                    </div>
                </div>

                <!-- Chart 1: Status Breakdown -->
                <div class="bg-white p-5 rounded-xl shadow-lg border-t-4 border-blue-500">
                    <h2 class="text-lg font-bold text-gray-800 mb-4 border-b pb-2">Order Status Breakdown</h2>
                    <div class="relative h-64 md:h-72">
                        <canvas id="statusChart"></canvas>
                    </div>
                </div>

                <!-- Chart 2: Monthly Quantity -->
                <div class="bg-white p-5 rounded-xl shadow-lg border-t-4 border-green-500">
                    <h2 class="text-lg font-bold text-gray-800 mb-4 border-b pb-2">Quantity Ordered (Last 6 Months)</h2>
                    <div class="relative h-64 md:h-72">
                        <canvas id="monthlyQtyChart"></canvas>
                    </div>
                </div>

            </div>
            <!-- End of Statistics Sidebar -->
            
        </div>
        <!-- End of responsive two-column layout -->
    </div>

    <!-- Add Modal -->
    <div id="addModal" class="modal hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4 overflow-auto">
        <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-md">
            <h2 class="text-lg font-bold mb-4">Add Work Order</h2>
            <form id="addForm" class="space-y-3">
                <input id="addWorkNo" placeholder="Work No" class="border px-3 py-2 w-full rounded-lg" required>
                <input id="addCompany" placeholder="Company" class="border px-3 py-2 w-full rounded-lg" required>
                <input id="addOrderDate" type="date" class="border px-3 py-2 w-full rounded-lg" required>
                <input id="addDeliveryDate" type="date" class="border px-3 py-2 w-full rounded-lg" required>
                <input id="addOrderQty" type="number" placeholder="Order Qty" class="border px-3 py-2 w-full rounded-lg" required>
                <select id="addStatus" class="border px-3 py-2 w-full rounded-lg bg-white">
                    <!-- Options will be populated by JS -->
                </select>
                <div class="flex justify-end gap-2 pt-2">
                    <button type="button" onclick="closeAddModal()" class="px-4 py-2 border rounded-lg hover:bg-gray-100">Cancel</button>
                    <button type="submit" id="addSubmitBtn" class="bg-indigo-600 text-white px-4 py-2 rounded-lg">Save</button>
                </div>
            </form>
            </div>
    </div>
    
    <!-- Edit Modal -->
    <div id="editModal" class="modal hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4 overflow-auto">
        <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-md">
            <h2 class="text-lg font-bold mb-4">Edit Work Order</h2>
            <form id="editForm" class="space-y-3">
                <!-- Storing the database 'id' (uuid) for updates -->
                <input type="hidden" id="editId">
                <input id="editWorkNo" placeholder="Work No" class="border px-3 py-2 w-full rounded-lg" required>
                <input id="editCompany" placeholder="Company" class="border px-3 py-2 w-full rounded-lg" required>
                <input id="editOrderDate" type="date" class="border px-3 py-2 w-full rounded-lg" required>
                <input id="editDeliveryDate" type="date" class="border px-3 py-2 w-full rounded-lg" required>
                <input id="editOrderQty" type="number" placeholder="Order Qty" class="border px-3 py-2 w-full rounded-lg" required>
                <select id="editStatus" class="border px-3 py-2 w-full rounded-lg bg-white">
                    <!-- Options will be populated by JS -->
                </select>
                <div class="flex justify-end gap-2 pt-2">
                    <button type="button" onclick="closeEditModal()" class="px-4 py-2 border rounded-lg hover:bg-gray-100">Cancel</button>
                    <button type="submit" id="editSubmitBtn" class="bg-indigo-600 text-white px-4 py-2 rounded-lg">Update</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Details Modal -->
    <div id="detailsModal" class="modal hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-40 p-4" onclick="closeDetailsModal()">
        <!-- MODIFIED: Increased max-width to 'max-w-lg' for image gallery -->
        <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-lg" onclick="event.stopPropagation()">
            <h2 id="detailsTitle" class="text-xl font-bold mb-4 text-gray-800">Work Order Details</h2>
            
            <!-- Details Content -->
            <div id="detailsContent" class="space-y-3"></div>
            
            <!-- NEW: Image Upload and Gallery Section -->
            <div class="mt-6 border-t pt-4">
                <h3 class="text-lg font-bold text-gray-800 mb-3">Manage Images</h3>
                
                <!-- Gallery -->
                <div id="imageGallery" class="grid grid-cols-3 sm:grid-cols-4 gap-2 mb-4 bg-gray-50 p-2 rounded-lg min-h-[80px]">
                    <!-- Images will be loaded here -->
                </div>

                <!-- Upload Form -->
                <div>
                    <label for="imageUpload" class="block text-sm font-medium text-gray-700">Upload New Images</label>
                    <input type="file" id="imageUpload" multiple class="mt-1 block w-full text-sm text-gray-900 border border-gray-300 rounded-lg cursor-pointer bg-gray-50 focus:outline-none" accept="image/*">
                    <button id="uploadBtn" class="bg-blue-600 text-white px-4 py-2 rounded-lg mt-3 w-full hover:bg-blue-700">
                        Upload
                    </button>
                    <div id="uploadSpinner" class="hidden text-center mt-2">
                        <span class="text-sm text-gray-500">Uploading...</span>
                    </div>
                </div>
            </div>
            <!-- End Image Section -->

            <button type="button" onclick="closeDetailsModal()" class="mt-6 w-full px-4 py-2 border rounded-lg hover:bg-gray-100">Close</button>
        </div>
    </div>
    
    <!-- Confirm Delete Modal -->
    <div id="confirmModal" class="modal hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-sm">
            <h2 class="text-lg font-bold mb-2">Are you sure?</h2>
            <p id="confirmText" class="text-gray-600 mb-6">This action cannot be undone.</p>
            <div class="flex justify-end gap-3">
                <button type="button" id="confirmCancelBtn" class="px-4 py-2 border rounded-lg hover:bg-gray-100">Cancel</button>
                <button type="button" id="confirmDeleteBtn" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700">Delete</button>
            </div>
        </div>
    </div>

    <script>
        // --- NEW: Supabase Setup ---
        // 1. Get these values from your Supabase project's API settings
        const SUPABASE_URL = 'YOUR_SUPABASE_URL'; 
        const SUPABASE_ANON_KEY = 'YOUR_SUPABASE_ANON_KEY';

        // 2. Create the Supabase client
        // Ensure you've enabled Row Level Security (RLS) and created policies in your Supabase project
        const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // 3. Define your Storage bucket name
        const IMAGE_BUCKET = 'work_order_images'; // Make sure this bucket exists and has RLS policies

        // --- End Supabase Setup ---


        let allData = [];
        let activeStatus = '';
        
        // --- NEW: Chart.js instances ---
        let statusChart = null;
        let monthlyQtyChart = null;

        // UPDATED stages array to include the new statuses in the production flow
        const stages = [
            'YET TO DESIGN',
            'DESIGNING',
            'MATERIAL PURCHASE',
            'CUTTING',
            'PRINTING',
            'STITCHING',
            'CHECKING/PACKING',
            'DISPATCHED', // New Stage
            'OUT FOR DELIVERY', // New Stage
            'DELIVERED'
        ];
        // allPossibleStatuses is automatically updated based on the new stages array
        const allPossibleStatuses = ['Unknown', ...stages, 'CANCELLED'];

        // --- Helper function to format date from 'MMM d, yyyy' to 'yyyy-MM-dd' ---
        function formatDateForInput(dateStr) {
            if (!dateStr || dateStr === 'N/A') return '';
            try {
                // Supabase provides dates as 'yyyy-MM-dd', which is what the input needs.
                // This function is now mainly for handling the display format if it's different.
                const dateObj = new Date(dateStr);
                if (isNaN(dateObj.getTime())) {
                    // Try parsing 'yyyy-MM-dd' directly
                    const parts = dateStr.split('-');
                    if (parts.length === 3) return dateStr; // Already in correct format
                    return '';
                }
                
                // Convert to ISO string and take the date part
                const iso = dateObj.toISOString().split('T')[0];
                return iso;
            } catch (e) {
                console.error("Error parsing date for input:", dateStr, e);
                return ''; // Return empty string if parsing fails
            }
        }
        
        // --- Helper to convert 'yyyy-MM-dd' back to 'MMM d, yyyy' for display ---
        function reformatDateForDisplay(dateStr) {
            if (!dateStr) return 'N/A';
            try {
                const [year, month, day] = dateStr.split('-').map(Number);
                if (!year || !month || !day) return dateStr; 
                const dateObj = new Date(Date.UTC(year, month - 1, day));
                return dateObj.toLocaleDateString('en-US', { 
                    month: 'short', 
                    day: 'numeric', 
                    year: 'numeric',
                    timeZone: 'UTC' 
                });
            } catch (e) {
                return dateStr; // Fallback
            }
        }
        
        // --- Helper to parse dates for reliable sorting and calculation ---
        function parseDate(dateStr) {
            // Supabase dates are 'yyyy-MM-dd'. We need to make sure JS parses this as UTC.
            if (!dateStr) return new Date(0);
            const parts = dateStr.split('-');
            if (parts.length === 3) {
                const d = new Date(Date.UTC(parts[0], parts[1] - 1, parts[2]));
                return isNaN(d.getTime()) ? new Date(0) : d;
            }
            // Fallback for other formats
            const d = new Date(dateStr);
            return isNaN(d.getTime()) ? new Date(0) : d;
        }

        document.addEventListener('DOMContentLoaded', () => {
            if (SUPABASE_URL === 'YOUR_SUPABASE_URL') {
                showError('Please update SUPABASE_URL and SUPABASE_ANON_KEY in the script tag.');
                document.getElementById('loader').style.display = 'none';
                return;
            }
            loadData();
            document.getElementById('search').addEventListener('input', render);
            document.getElementById('sort').addEventListener('change', render);
            document.getElementById('addForm').addEventListener('submit', submitAdd);
            document.getElementById('editForm').addEventListener('submit', submitEdit);
        });

        async function loadData() {
            showError(null); // Clear previous errors
            document.getElementById('loader').style.display = 'block';

            // --- REPLACED: Google Apps Script with Supabase ---
            // We fetch work_orders and all related work_order_images in one query
            const { data, error } = await supabase
                .from('work_orders')
                .select(`
                    id, 
                    work_no, 
                    company, 
                    order_date, 
                    delivery_date, 
                    order_qty, 
                    status,
                    work_order_images ( id, image_path )
                `)
                .order('work_no', { ascending: false }); // Default sort by work_no desc

            if (error) {
                return handleFailure(error);
            }

            handleSuccess(data || []);
        }

        function handleSuccess(data) {
            document.getElementById('loader').style.display = 'none';
            
            // --- MODIFIED: Map snake_case from Supabase to camelCase for JS code ---
            allData = data.map(item => ({
                id: item.id, // NEW: Need the 'id' (uuid) for updates and image relations
                workNo: item.work_no,
                company: item.company,
                // Reformat dates for display right away
                orderDate: reformatDateForDisplay(item.order_date),
                deliveryDate: reformatDateForDisplay(item.delivery_date),
                // Store raw date for editing
                rawOrderDate: item.order_date, 
                rawDeliveryDate: item.delivery_date,
                orderQty: item.order_qty,
                status: String(item.status || 'Unknown').trim().toUpperCase(),
                images: item.work_order_images || [] // NEW: Store the array of images
            }));
            
            populateStatusDropdowns();
            buildStatusFilters();
            render();
            renderStats(); // <--- Update statistics after data load
            renderUpcomingOrders(); // <--- NEW: Render upcoming orders
        }

        function handleFailure(err) {
            document.getElementById('loader').style.display = 'none';
            showError(err.message || 'An unknown error occurred.');
            console.error(err);
        }

        // --- FIX: Improved Error Box Functionality ---
        function showError(message) {
            const box = document.getElementById('error-message');
            if (message) {
                document.getElementById('error-text').textContent = message;
                box.classList.remove('hidden');
            } else {
                box.classList.add('hidden');
            }
        }
        
        function populateStatusDropdowns() {
            const addSelect = document.getElementById('addStatus');
            const editSelect = document.getElementById('editStatus');
            addSelect.innerHTML = '';
            editSelect.innerHTML = '';
            
            allPossibleStatuses.forEach(status => {
                const option = new Option(status, status);
                addSelect.add(option.cloneNode(true));
                editSelect.add(option.cloneNode(true));
            });
        }

        function buildStatusFilters() {
            const statuses = [...new Set(allData.map(i => i.status))].sort();
            const div = document.getElementById('statusFilters');
            div.innerHTML = '';
            
            ['ALL', ...statuses].forEach(st => {
                const btn = document.createElement('button');
                btn.textContent = st;
                // --- UPDATED: Check for special 'IN_PROGRESS_FILTER' ---
                const isActive = (activeStatus === '' && st === 'ALL') || activeStatus === st;
                btn.className = `filter-btn px-3 py-1 rounded-full border text-sm shadow-sm ${isActive ? 'bg-indigo-600 text-white border-indigo-600' : 'bg-white text-gray-700 hover:bg-gray-50'}`;
                
                btn.onclick = () => {
                    activeStatus = (st === 'ALL') ? '' : st;
                    buildStatusFilters();
                    render();
                };
                div.appendChild(btn);
            });
        }

        function render() {
            const search = document.getElementById('search').value.toLowerCase();
            const sort = document.getElementById('sort').value;
            
            // --- UPDATED: Filter logic to handle 'IN_PROGRESS_FILTER' ---
            let data = allData.filter(i => {
                const searchMatch = (String(i.workNo).toLowerCase().includes(search) ||
                    String(i.company).toLowerCase().includes(search));
                
                if (activeStatus === 'IN_PROGRESS_FILTER') {
                    return searchMatch && i.status !== 'DELIVERED' && i.status !== 'CANCELLED';
                } else if (activeStatus === '') { // 'ALL'
                    return searchMatch;
                } else { // Specific status filter
                    return searchMatch && i.status === activeStatus;
                }
            });

            // --- Sort data ---
            const collator = new Intl.Collator(undefined, { numeric: true, sensitivity: 'base' });
            
            if (sort === 'workno-asc') data.sort((a,b) => collator.compare(a.workNo, b.workNo));
            else if (sort === 'workno-desc') data.sort((a,b) => collator.compare(b.workNo, a.workNo));
            // Use raw dates for sorting
            else if (sort === 'delivery-asc') data.sort((a,b) => parseDate(a.rawDeliveryDate) - parseDate(b.rawDeliveryDate));
            else if (sort === 'delivery-desc') data.sort((a,b) => parseDate(b.rawDeliveryDate) - parseDate(a.rawDeliveryDate));
            else if (sort === 'qty-asc') data.sort((a,b) => (a.orderQty || 0) - (b.orderQty || 0));
            else if (sort === 'qty-desc') data.sort((a,b) => (b.orderQty || 0) - (a.orderQty || 0));
            else {
                // Default sort (already done by Supabase, but we'll keep it for filtered data)
                data.sort((a,b) => collator.compare(b.workNo, a.workNo));
            }

            const div = document.getElementById('cards');
            div.innerHTML = '';
            if (data.length === 0) {
                div.innerHTML = '<p class="text-center text-gray-500">No work orders found.</p>';
                return;
            }

            data.forEach(item => {
                const { colorName, colorClasses } = getColor(item.status);
                const progress = getProgress(item.status);
                const card = document.createElement('div');
                card.className = `card-item ${colorClasses} bg-white rounded-lg shadow p-4 cursor-pointer`;
                card.onclick = () => openDetailsModal(item);
                
                card.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <h3 class="font-bold text-lg ${colorName}">${item.workNo}</h3>
                        <!-- MODIFIED: Pass item.id (uuid) to onStatusChange -->
                        <select class="status-dropdown border rounded-lg px-2 py-1 text-sm bg-white" onchange="onStatusChange(event, '${item.id}')" onclick="event.stopPropagation()">
                            ${allPossibleStatuses.map(s => `<option value="${s}" ${s === item.status ? 'selected' : ''}>${s}</option>`).join('')}
                        </select>
                    </div>
                    <p class="text-gray-700 font-medium">${item.company || 'N/A'}</p>
                    <p class="text-sm text-gray-500">Delivery: ${item.deliveryDate || 'N/A'}</p>
                    <p class="text-sm text-gray-500 mb-3">Qty: ${item.orderQty || '0'}</p>
                    
                    <div class="w-full bg-gray-200 rounded-full h-2.5 mb-3">
                        <div class="progress-bar h-2.5 rounded-full ${progress.color}" style="width:${progress.percent}%;"></div>
                    </div>
                    
                    <div class="flex justify-end gap-2">
                        <button class="edit-btn text-sm text-blue-600 hover:underline">Edit</button>
                        <button class="delete-btn text-sm text-red-600 hover:underline">Delete</button>
                    </div>
                `;
                
                card.querySelector('.delete-btn').addEventListener('click', (e) => {
                    e.stopPropagation(); // Stop click from bubbling up to the card
                    // MODIFIED: Pass item.id (uuid) for deletion
                    openConfirmModal(item.id, 'order', item.workNo);
                });
                
                card.querySelector('.edit-btn').addEventListener('click', (e) => {
                    e.stopPropagation(); // Stop click from bubbling up to the card
                    openEditModal(item);
                });

                div.appendChild(card);
            });
        }

        // ... (getColor, getChartColors, getProgress functions are unchanged) ...
        // UPDATED: Added new colors for the DISPATCHED and OUT FOR DELIVERY statuses
        function getColor(status) {
            const s = (status || '').toUpperCase();
            if (s === 'YET TO DESIGN') return { colorName: 'text-gray-600', colorClasses: 'border-l-4 border-gray-400' };
            if (s === 'DESIGNING') return { colorName: 'text-blue-600', colorClasses: 'border-l-4 border-blue-400' };
            if (s === 'MATERIAL PURCHASE') return { colorName: 'text-yellow-600', colorClasses: 'border-l-4 border-yellow-400' };
            if (s === 'CUTTING') return { colorName: 'text-orange-600', colorClasses: 'border-l-4 border-orange-400' };
            if (s === 'PRINTING') return { colorName: 'text-purple-600', colorClasses: 'border-l-4 border-purple-400' };
            if (s === 'STITCHING') return { colorName: 'text-pink-600', colorClasses: 'border-l-4 border-pink-400' };
            if (s === 'CHECKING/PACKING') return { colorName: 'text-teal-600', colorClasses: 'border-l-4 border-teal-400' };
            if (s === 'DISPATCHED') return { colorName: 'text-cyan-600', colorClasses: 'border-l-4 border-cyan-400' }; // Cyan for Dispatched
            if (s === 'OUT FOR DELIVERY') return { colorName: 'text-sky-600', colorClasses: 'border-l-4 border-sky-400' }; // Sky for Out For Delivery
            if (s === 'DELIVERED') return { colorName: 'text-green-600', colorClasses: 'border-l-4 border-green-500' };
            if (s === 'CANCELLED') return { colorName: 'text-red-600', colorClasses: 'border-l-4 border-red-500' };
            return { colorName: 'text-gray-400', colorClasses: 'border-l-4 border-gray-300' }; // Default for Unknown
        }
        
        // --- NEW: Helper function to get hex colors for charts ---
        function getChartColors(status) {
            const s = (status || '').toUpperCase();
            if (s === 'YET TO DESIGN') return '#9CA3AF'; // gray-400
            if (s === 'DESIGNING') return '#3B82F6'; // blue-500
            if (s === 'MATERIAL PURCHASE') return '#F59E0B'; // yellow-500
            if (s === 'CUTTING') return '#F97316'; // orange-500
            if (s === 'PRINTING') return '#A855F7'; // purple-500
            if (s === 'STITCHING') return '#EC4899'; // pink-500
            if (s === 'CHECKING/PACKING') return '#14B8A6'; // teal-500
            if (s === 'DISPATCHED') return '#06B6D4'; // cyan-500
            if (s === 'OUT FOR DELIVERY') return '#0EA5E9'; // sky-500
            if (s === 'DELIVERED') return '#22C55E'; // green-500
            if (s === 'CANCELLED') return '#EF4444'; // red-500
            return '#D1D5DB'; // gray-300 (Unknown)
        }

        function getProgress(status) {
            const s = (status || '').toUpperCase();
            // The index will now correctly calculate progress based on the new 10-stage array
            const index = stages.indexOf(s);
            // We now have 10 stages, so index 0 ('YET TO DESIGN') should be 10%
            const percent = ((index + 1) / stages.length) * 100;

            if (s === 'DELIVERED') return { percent: 100, color: 'bg-green-500' };
            if (s === 'CANCELLED') return { percent: 0, color: 'bg-red-500' };
            if (index === -1) return { percent: 0, color: 'bg-gray-400' }; // For Unknown

            return { percent: percent, color: 'bg-indigo-500' }; // In-progress stages
        }
        
        // --- Statistics Calculation and Rendering ---

        function calculateStats() {
            if (!allData || allData.length === 0) {
                return {
                    totalOrders: 0, totalQty: 0, inProgress: 0,
                    delivered: 0, deliveredQty: 0, nextDelivery: 'N/A',
                    cancelled: 0 
                };
            }

            const stats = {
                totalOrders: allData.length, totalQty: 0, inProgress: 0,
                delivered: 0, deliveredQty: 0,
                nextDeliveryDate: new Date(8640000000000000), // Far future
                cancelled: 0 
            };

            const today = new Date();
            today.setHours(0,0,0,0);

            allData.forEach(item => {
                const qty = parseInt(item.orderQty) || 0;
                const status = (item.status || '').toUpperCase();
                stats.totalQty += qty;
                
                // --- UPDATED Logic ---
                if (status === 'DELIVERED') {
                    stats.delivered++;
                    stats.deliveredQty += qty;
                } else if (status === 'CANCELLED') {
                    stats.cancelled++;
                } else {
                    stats.inProgress++;
                }
                // --- End Updated Logic ---

                // Calculate next delivery date for non-delivered/non-cancelled items
                if (status !== 'DELIVERED' && status !== 'CANCELLED' && item.rawDeliveryDate) {
                    const deliveryDate = parseDate(item.rawDeliveryDate);
                    if (deliveryDate.getTime() >= today.getTime() && deliveryDate < stats.nextDeliveryDate) {
                        stats.nextDeliveryDate = deliveryDate;
                    }
                }
            });

            // Format next delivery date
            stats.nextDelivery = (stats.nextDeliveryDate.getTime() === new Date(8640000000000000).getTime()) 
                ? 'None Scheduled' 
                : stats.nextDeliveryDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', timeZone: 'UTC' });
                
            return stats;
        }
        // ... (renderStats, renderUpcomingOrders, filterFromStats functions are unchanged) ...
        // --- UPDATED: Renders stats AND charts ---
        function renderStats() {
            const stats = calculateStats();
            const section1 = document.getElementById('stats-section-1-content');
            const section2 = document.getElementById('stats-section-2-content');
            
            // --- Section 1: Order Summary (NOW 3 COLS) ---
            section1.innerHTML = `
                <!-- Stat Card 1: Total Orders (Clickable) -->
                <div class="bg-indigo-50 p-3 rounded-lg stat-card stat-clickable" onclick="filterFromStats('ALL')">
                    <p class="text-sm font-medium text-gray-500">Total Orders</p>
                    <p class="text-2xl font-extrabold text-indigo-600 mt-1">${stats.totalOrders}</p>
                </div>
                <!-- Stat Card 2: Orders In Progress (NOW Clickable) -->
                <div class="bg-yellow-50 p-3 rounded-lg stat-card stat-clickable" onclick="filterFromStats('IN PROGRESS')">
                    <p class="text-sm font-medium text-gray-500">In Progress</p>
                    <p class="text-2xl font-extrabold text-yellow-600 mt-1">${stats.inProgress}</p>
                </div>
                <!-- Stat Card 3: Delivered Count (Clickable) -->
                <div class="bg-green-50 p-3 rounded-lg stat-card stat-clickable" onclick="filterFromStats('DELIVERED')">
                    <p class="text-sm font-medium text-gray-500">Delivered</p>
                    <p class="text-2xl font-extrabold text-green-600 mt-1">${stats.delivered}</p>
                </div>
                <!-- Stat Card 4: Cancelled (Clickable) -->
                <div class="bg-red-50 p-3 rounded-lg stat-card stat-clickable" onclick="filterFromStats('CANCELLED')">
                    <p class="text-sm font-medium text-gray-500">Cancelled</p>
                    <p class="text-2xl font-extrabold text-red-600 mt-1">${stats.cancelled}</p>
                </div>
                <!-- Stat Card 5: Next Delivery (Not clickable) -->
                <div class="bg-blue-50 p-3 rounded-lg stat-card stat-default">
                    <p class="text-sm font-medium text-gray-500">Next Due</p>
                    <p class="text-2xl font-extrabold text-blue-600 mt-1">${stats.nextDelivery}</p>
                </div>
            `;

            // --- Section 2: Quantity Metrics ---
            const deliveryRate = stats.totalQty > 0 ? (stats.deliveredQty / stats.totalQty * 100).toFixed(1) : '0.0';
            
            section2.innerHTML = `
                <div class="p-3 rounded-lg bg-gray-50 stat-card">
                    <p class="text-sm font-medium text-gray-500">Total Quantity Ordered</p>
                    <p class="text-2xl font-extrabold text-gray-800 mt-1">${stats.totalQty.toLocaleString()}</p>
                </div>
                <div class="p-3 rounded-lg bg-green-50 stat-card">
                    <p class="text-sm font-medium text-gray-500">Quantity Delivered</p>
                    <p class="text-2xl font-extrabold text-green-600 mt-1">${stats.deliveredQty.toLocaleString()}</p>
                </div>
                <div class="p-3 rounded-lg bg-indigo-50 stat-card">
                    <p class="text-sm font-medium text-gray-500">Delivery Rate (Qty)</p>
                    <p class="text-2xl font-extrabold text-indigo-600 mt-1">${deliveryRate}%</p>
                </div>
            `;

            // --- Chart Rendering Logic ---
            
            // 1. Destroy old charts to prevent errors
            if (statusChart) statusChart.destroy();
            if (monthlyQtyChart) monthlyQtyChart.destroy();

            // --- Chart 1: Status Breakdown (Donut Chart) ---
            const statusCounts = allData.reduce((acc, item) => {
                const status = (item.status || 'Unknown').toUpperCase();
                acc[status] = (acc[status] || 0) + 1;
                return acc;
            }, {});

            const sortedStatuses = Object.keys(statusCounts).sort();
            const statusLabels = sortedStatuses;
            const statusData = sortedStatuses.map(status => statusCounts[status]);
            const statusColors = sortedStatuses.map(status => getChartColors(status));

            const ctxStatus = document.getElementById('statusChart').getContext('2d');
            statusChart = new Chart(ctxStatus, {
                type: 'doughnut',
                data: {
                    labels: statusLabels,
                    datasets: [{
                        label: 'Work Orders',
                        data: statusData,
                        backgroundColor: statusColors,
                        borderWidth: 2,
                        borderColor: '#ffffff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 10,
                                boxWidth: 12,
                                font: { size: 10 }
                            }
                        }
                    }
                }
            });

            // --- Chart 2: Monthly Quantity (Bar Chart) ---
            const last6Months = [];
            const monthData = new Map();
            const now = new Date();
            now.setDate(1); // Start from the 1st of the current month

            for (let i = 5; i >= 0; i--) {
                const monthDate = new Date(now.getFullYear(), now.getMonth() - i, 1);
                const monthLabel = monthDate.toLocaleDateString('en-US', { month: 'short', year: '2-digit' });
                last6Months.push(monthLabel);
                monthData.set(monthLabel, 0);
            }

            allData.forEach(item => {
                const qty = parseInt(item.orderQty) || 0;
                if (!item.rawOrderDate || qty === 0) return; // Use raw date

                const orderDate = parseDate(item.rawOrderDate); // Use raw date
                if (isNaN(orderDate.getTime())) return;
                
                const monthLabel = orderDate.toLocaleDateString('en-US', { month: 'short', year: '2-digit', timeZone: 'UTC' });
                if (monthData.has(monthLabel)) {
                    monthData.set(monthLabel, monthData.get(monthLabel) + qty);
                }
            });

            const qtyData = Array.from(monthData.values());

            const ctxQty = document.getElementById('monthlyQtyChart').getContext('2d');
            monthlyQtyChart = new Chart(ctxQty, {
                type: 'bar',
                data: {
                    labels: last6Months,
                    datasets: [{
                        label: 'Total Quantity Ordered',
                        data: qtyData,
                        backgroundColor: 'rgba(79, 70, 229, 0.7)', // Indigo-600
                        borderColor: 'rgba(79, 70, 229, 1)',
                        borderWidth: 1,
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: '#e5e7eb' }
                        },
                        x: { grid: { display: false } }
                    },
                    plugins: {
                        legend: { display: false }
                    }
                }
            });
        }

        // --- NEW: Function to render the upcoming orders list ---
        function renderUpcomingOrders() {
            const listDiv = document.getElementById('upcoming-orders-list');
            const today = new Date();
            today.setHours(0, 0, 0, 0); // Normalize to start of today

            const upcoming = allData.filter(item => {
                const status = (item.status || 'Unknown').toUpperCase();
                if (status === 'DELIVERED' || status === 'CANCELLED') {
                    return false;
                }
                const deliveryDate = parseDate(item.rawDeliveryDate); // Use raw date
                // Check if date is valid and is today or in the future
                return deliveryDate.getTime() >= today.getTime();
            }).sort((a, b) => parseDate(a.rawDeliveryDate) - parseDate(b.rawDeliveryDate)); // Sort by soonest

            if (upcoming.length === 0) {
                listDiv.innerHTML = '<p class="text-sm text-gray-500">No upcoming orders found.</p>';
                return;
            }

            listDiv.innerHTML = upcoming.map(item => {
                const deliveryDate = parseDate(item.rawDeliveryDate); // Use raw date
                // Calculate days left
                const diffTime = deliveryDate.getTime() - today.getTime();
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                
                let daysLeftText = '';
                if (diffDays === 0) {
                    daysLeftText = '<span class="font-bold text-red-600">Due Today</span>';
                } else if (diffDays === 1) {
                    daysLeftText = '<span class="font-medium text-orange-600">1 day left</span>';
                } else {
                    daysLeftText = `<span class="text-gray-600">${diffDays} days left</span>`;
                }

                return `
                    <div class="border-b pb-2 last:border-b-0">
                        <div class="flex justify-between items-center">
                            <span class="font-medium text-gray-800">${item.company}</span>
                            ${daysLeftText}
                        </div>
                        <div class="text-sm text-gray-500">${item.deliveryDate} (Work #: ${item.workNo})</div>
                    </div>
                `;
            }).join('');
        }

        // --- UPDATED: Function to handle clicks from stat cards ---
        function filterFromStats(status) {
            if (status === 'ALL') {
                activeStatus = '';
            } else if (status === 'IN PROGRESS') {
                activeStatus = 'IN_PROGRESS_FILTER'; // Special key
            } else {
                activeStatus = status; // 'DELIVERED' or 'CANCELLED'
            }
            buildStatusFilters(); // Refreshes the filter buttons to show the new active state
            render(); // Re-renders the cards with the new filter
        }

        // --- Details Modal Functions ---
        function openDetailsModal(item) {
            document.getElementById('detailsTitle').textContent = `Work Order: ${item.workNo}`;
            const content = document.getElementById('detailsContent');
            const progress = getProgress(item.status);
            
            content.innerHTML = `
                <p><strong class="text-gray-500 w-24 inline-block">Company:</strong> ${item.company}</p>
                <p><strong class="text-gray-500 w-24 inline-block">Order Date:</strong> ${item.orderDate}</p>
                <p><strong class="text-gray-500 w-24 inline-block">Delivery:</strong> ${item.deliveryDate}</p>
                <p><strong class="text-gray-500 w-24 inline-block">Quantity:</strong> ${item.orderQty}</p>
                <p><strong class="text-gray-500 w-24 inline-block">Status:</strong> ${item.status}</p>
                <div class="w-full bg-gray-200 rounded-full h-4 mt-2">
                    <div class="progress-bar h-4 rounded-full ${progress.color} flex items-center justify-center text-xs text-white" style="width:${progress.percent}%;">
                        ${progress.percent > 15 ? progress.percent.toFixed(0)+'%' : ''}
                    </div>
                </div>
            `;

            // --- NEW: Image Gallery and Upload Logic ---
            const gallery = document.getElementById('imageGallery');
            gallery.innerHTML = ''; // Clear old images
            
            if (item.images && item.images.length > 0) {
                item.images.forEach(image => {
                    // Get public URL for the image
                    const { data } = supabase
                        .storage
                        .from(IMAGE_BUCKET)
                        .getPublicUrl(image.image_path);
                    
                    if (data.publicUrl) {
                        const imgContainer = document.createElement('div');
                        imgContainer.className = 'gallery-image-container rounded-lg overflow-hidden border border-gray-200';
                        imgContainer.innerHTML = `
                            <img src="${data.publicUrl}" alt="Work order image" class="w-full h-24 object-cover">
                            <button class="gallery-delete-btn" onclick="openConfirmModal('${image.id}', 'image', '${image.image_path}')">&times;</button>
                        `;
                        gallery.appendChild(imgContainer);
                    }
                });
            } else {
                gallery.innerHTML = '<p class="text-sm text-gray-500 col-span-full text-center">No images uploaded.</p>';
            }

            // Bind upload button click event
            document.getElementById('uploadBtn').onclick = () => uploadImages(item);
            // --- End Image Logic ---

            document.getElementById('detailsModal').classList.remove('hidden');
        }
        
        function closeDetailsModal() {
            document.getElementById('detailsModal').classList.add('hidden');
        }
        
        // --- Function to handle direct status change from card ---
        async function onStatusChange(event, itemId) {
            const newStatus = event.target.value;
            const select = event.target;
            select.disabled = true;

            // --- REPLACED: Google Apps Script with Supabase ---
            const { error } = await supabase
                .from('work_orders')
                .update({ status: newStatus })
                .eq('id', itemId); // Use the 'id' (uuid) to update

            if (error) {
                handleFailure(error);
                loadData(); // Reload data to revert any optimistic changes
            } else {
                // Update local data for immediate UI response
                const itemIndex = allData.findIndex(i => i.id == itemId);
                if (itemIndex > -1) {
                    allData[itemIndex].status = newStatus;
                }
                render();
                buildStatusFilters();
                renderStats();
                renderUpcomingOrders();
            }
            // 'select.disabled = false' is not needed since render() rebuilds the card
        }

        // --- ADD ---
        function openAddModal() {
            document.getElementById('addForm').reset();
            document.getElementById('addModal').classList.remove('hidden');
        }
        function closeAddModal() {
            document.getElementById('addModal').classList.add('hidden');
        }
        async function submitAdd(e) {
            e.preventDefault();
            const btn = document.getElementById('addSubmitBtn');
            btn.disabled = true;
            btn.textContent = 'Saving...';
            
            // --- MODIFIED: Use snake_case for Supabase ---
            const newOrder = {
                work_no: document.getElementById('addWorkNo').value,
                company: document.getElementById('addCompany').value,
                order_date: document.getElementById('addOrderDate').value,
                delivery_date: document.getElementById('addDeliveryDate').value,
                order_qty: parseInt(document.getElementById('addOrderQty').value),
                status: document.getElementById('addStatus').value
            };
            
            // --- REPLACED: Google Apps Script with Supabase ---
            const { error } = await supabase
                .from('work_orders')
                .insert([newOrder]);

            btn.disabled = false;
            btn.textContent = 'Save';

            if (error) {
                // Check for unique constraint violation
                if (error.code === '23505') {
                    handleFailure({ message: `Work No "${newOrder.work_no}" already exists.` });
                } else {
                    handleFailure(error);
                }
            } else {
                closeAddModal();
                loadData(); // Reload all data from Supabase
            }
        }
        
        // --- Edit Modal Functions ---
        function openEditModal(item) {
            // Pre-fill form
            document.getElementById('editId').value = item.id; // Store the 'id' (uuid)
            document.getElementById('editWorkNo').value = item.workNo;
            document.getElementById('editCompany').value = item.company;
            // Use the raw yyyy-MM-dd date
            document.getElementById('editOrderDate').value = item.rawOrderDate;
            document.getElementById('editDeliveryDate').value = item.rawDeliveryDate;
            document.getElementById('editOrderQty').value = item.orderQty;
            document.getElementById('editStatus').value = item.status;
            
            document.getElementById('editModal').classList.remove('hidden');
        }
        
        function closeEditModal() {
            document.getElementById('editModal').classList.add('hidden');
        }
        
        async function submitEdit(e) {
            e.preventDefault();
            const btn = document.getElementById('editSubmitBtn');
            btn.disabled = true;
            btn.textContent = 'Updating...';

            // --- MODIFIED: Use snake_case for Supabase ---
            const updatedOrder = {
                work_no: document.getElementById('editWorkNo').value,
                company: document.getElementById('editCompany').value,
                order_date: document.getElementById('editOrderDate').value,
                delivery_date: document.getElementById('editDeliveryDate').value,
                order_qty: parseInt(document.getElementById('editOrderQty').value),
                status: document.getElementById('editStatus').value
            };
            
            const itemId = document.getElementById('editId').value;

            // --- REPLACED: Google Apps Script with Supabase ---
            const { error } = await supabase
                .from('work_orders')
                .update(updatedOrder)
                .eq('id', itemId); // Use the 'id' (uuid) to update

            btn.disabled = false;
            btn.textContent = 'Update';

            if (error) {
                if (error.code === '23505') {
                    handleFailure({ message: `Work No "${updatedOrder.work_no}" already exists.` });
                } else {
                    handleFailure(error);
                }
            } else {
                closeEditModal();
                loadData(); // Reload all data
            }
        }

        // --- NEW: Image Upload Function ---
        async function uploadImages(item) {
            const uploadInput = document.getElementById('imageUpload');
            const files = uploadInput.files;
            
            if (!files || files.length === 0) {
                showError("Please select one or more images to upload.");
                return;
            }

            const uploadBtn = document.getElementById('uploadBtn');
            const uploadSpinner = document.getElementById('uploadSpinner');
            uploadBtn.disabled = true;
            uploadSpinner.classList.remove('hidden');

            try {
                // Create an array of upload promises
                const uploadPromises = [];
                for (const file of files) {
                    const filePath = `public/${item.workNo}/${Date.now()}-${file.name}`;
                    uploadPromises.push(
                        supabase.storage.from(IMAGE_BUCKET).upload(filePath, file)
                    );
                }

                // Wait for all uploads to finish
                const uploadResults = await Promise.all(uploadPromises);

                // Check for errors and prepare DB inserts
                const newImageRecords = [];
                for (const result of uploadResults) {
                    if (result.error) {
                        throw new Error(`Failed to upload ${result.data.path}: ${result.error.message}`);
                    }
                    newImageRecords.push({
                        work_order_id: item.id,
                        image_path: result.data.path
                    });
                }

                // Insert all new image records into the database
                if (newImageRecords.length > 0) {
                    const { error: dbError } = await supabase
                        .from('work_order_images')
                        .insert(newImageRecords);

                    if (dbError) {
                        throw new Error(`Failed to save image records: ${dbError.message}`);
                    }
                }

                // Success!
                closeDetailsModal();
                loadData(); // Refresh all data

            } catch (error) {
                handleFailure(error);
            } finally {
                uploadBtn.disabled = false;
                uploadSpinner.classList.add('hidden');
                uploadInput.value = ''; // Clear the file input
            }
        }


        // --- DELETE ---
        // MODIFIED: Function now handles deleting 'order' or 'image'
        function openConfirmModal(id, type = 'order', associatedData) {
            let text = '';
            let deleteFunction;

            if (type === 'order') {
                text = `Are you sure you want to delete Work No ${associatedData}? This cannot be undone.`;
                deleteFunction = () => performOrderDelete(id);
            } else if (type === 'image') {
                text = `Are you sure you want to delete this image? This cannot be undone.`;
                // associatedData in this case is the image_path
                deleteFunction = () => performImageDelete(id, associatedData);
            }

            document.getElementById('confirmText').textContent = text;
            document.getElementById('confirmModal').classList.remove('hidden');
            
            document.getElementById('confirmDeleteBtn').onclick = deleteFunction;
            document.getElementById('confirmCancelBtn').onclick = closeConfirmModal;
        }

        async function performOrderDelete(itemId) {
            const btn = document.getElementById('confirmDeleteBtn');
            btn.textContent = 'Deleting...';
            btn.disabled = true;
            
            // --- REPLACED: Google Apps Script with Supabase ---
            // Note: RLS policies must allow delete.
            // If you set up 'ON DELETE CASCADE' for the foreign key on work_order_images,
            // Supabase will automatically delete all associated images from the DB.
            // However, it will NOT delete them from Storage.
            
            // TODO: For a complete solution, you would first query all image paths for this order,
            // delete them from Storage, then delete the order record.
            // For simplicity, we just delete the order record here.
            
            const { error } = await supabase
                .from('work_orders')
                .delete()
                .eq('id', itemId); // Use 'id' (uuid) to delete

            if (error) {
                handleFailure(error);
            } else {
                closeConfirmModal();
                loadData(); // Reload data
            }
        }

        // --- NEW: Function to delete a single image ---
        async function performImageDelete(imageId, imagePath) {
            const btn = document.getElementById('confirmDeleteBtn');
            btn.textContent = 'Deleting...';
            btn.disabled = true;

            try {
                // 1. Delete from Storage
                const { error: storageError } = await supabase
                    .storage
                    .from(IMAGE_BUCKET)
                    .remove([imagePath]);
                
                if (storageError) {
                    // Log the error but proceed to delete from DB anyway
                    console.error("Storage delete error:", storageError.message);
                }

                // 2. Delete from Database
                const { error: dbError } = await supabase
                    .from('work_order_images')
                    .delete()
                    .eq('id', imageId);

                if (dbError) {
                    throw new Error(dbError.message);
                }

                closeConfirmModal();
                closeDetailsModal(); // Close the details modal too
                loadData(); // Reload all data

            } catch (error) {
                handleFailure(error);
                closeConfirmModal();
            }
        }
        
        function closeConfirmModal() {
            document.getElementById('confirmModal').classList.add('hidden');
            document.getElementById('confirmDeleteBtn').textContent = 'Delete';
            document.getElementById('confirmDeleteBtn').disabled = false;
        }
    </script>
</body>
</html>
