<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real-Time Todo List</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        /* Custom scrollbar style for aesthetics */
        #todo-list-container::-webkit-scrollbar { width: 6px; }
        #todo-list-container::-webkit-scrollbar-thumb { background-color: #a5b4fc; border-radius: 3px; }
        #todo-list-container::-webkit-scrollbar-track { background-color: #f1f5f9; }
    </style>
</head>
<body class="bg-indigo-50 min-h-screen flex items-start justify-center p-4 sm:p-8">

    <div class="bg-white p-6 sm:p-10 rounded-2xl shadow-2xl w-full max-w-xl mt-10">
        
        <!-- Header and User ID Display -->
        <h1 class="text-4xl font-extrabold text-gray-800 mb-2">Todo List</h1>
        <p class="text-sm text-indigo-500 mb-6 font-mono break-all">
            User ID: <span id="user-id" class="font-bold">Loading...</span>
        </p>
        
        <!-- Input Form -->
        <div class="flex space-x-2 mb-8">
            <input 
                type="text" 
                id="todo-input" 
                placeholder="Add a new task..." 
                class="flex-grow p-3 border-2 border-indigo-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition duration-150"
            >
            <button 
                id="add-button" 
                class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 px-4 rounded-lg shadow-md transition duration-150 transform active:scale-95 disabled:opacity-50"
                disabled
            >
                Add
            </button>
        </div>

        <!-- Todo List Container -->
        <div id="todo-list-container" class="space-y-3 max-h-80 overflow-y-auto pr-2">
            <!-- Todos will be injected here -->
            <p id="loading-message" class="text-gray-500 text-center py-4">Loading tasks...</p>
        </div>
    </div>

    <script type="module">
        // Import necessary Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, setLogLevel, collection, addDoc, onSnapshot, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables for Firebase instances and user data
        let app = null;
        let db = null;
        let auth = null;
        let userId = null;
        let appId = 'default-app-id'; // Will be overwritten by __app_id

        const userIdDisplay = document.getElementById('user-id');
        const todoInput = document.getElementById('todo-input');
        const addButton = document.getElementById('add-button');
        const todoListContainer = document.getElementById('todo-list-container');
        const loadingMessage = document.getElementById('loading-message');

        // --- Firebase Configuration & Auth Setup (Robust Code) ---

        // Get the App ID and Firebase Config from global environment variables
        appId = typeof __app_id !== 'undefined' ? __app_id : appId;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        let firebaseConfig = null;
        
        try {
            if (typeof __firebase_config !== 'undefined') {
                firebaseConfig = JSON.parse(__firebase_config);
            } else {
                throw new Error("Missing __firebase_config");
            }
        } catch (e) {
            console.error("Fatal Error: Firebase configuration could not be loaded or parsed.", e);
            todoListContainer.innerHTML = '<p class="text-red-500 text-center py-4">Initialization failed. Check console.</p>';
            throw e; 
        }

        /**
         * Returns the reference to the user's private Todos collection.
         * Data path: /artifacts/{appId}/users/{userId}/todos
         */
        function getTodosCollectionRef() {
            if (!db || !userId) return null;
            // IMPORTANT: Storing data in the user-specific private path
            const path = `artifacts/${appId}/users/${userId}/todos`;
            return collection(db, path);
        }

        async function initializeFirebase() {
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // MANDATORY: Set log level for debugging
                setLogLevel('debug'); 

                // Sign in with token or anonymously
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                // Listen for Auth State Changes
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        userIdDisplay.textContent = userId;
                        addButton.disabled = false; // Enable UI interaction
                        setupRealtimeListener();
                        console.log("Firebase initialized and user ready.");
                    } else {
                        userIdDisplay.textContent = 'N/A (Unauthenticated)';
                        // Re-attempt sign-in if somehow logged out
                        signInAnonymously(auth); 
                    }
                });

            } catch (error) {
                console.error("Firebase Initialization Error:", error);
                loadingMessage.textContent = `Initialization failed: ${error.message}`;
                loadingMessage.className = 'text-red-500 text-center py-4';
            }
        }

        // --- Todo List Application Logic ---

        /**
         * Adds a new todo item to Firestore.
         */
        async function addTodo() {
            const task = todoInput.value.trim();
            if (!task || !db || !userId) return;

            addButton.disabled = true; // Disable while saving
            
            try {
                await addDoc(getTodosCollectionRef(), {
                    task: task,
                    completed: false,
                    createdAt: Date.now()
                });
                todoInput.value = ''; // Clear input on success
                todoInput.focus();
            } catch (error) {
                console.error("Error adding document: ", error);
            } finally {
                addButton.disabled = false; // Re-enable button
            }
        }

        /**
         * Deletes a todo item from Firestore.
         * @param {string} docId The Firestore document ID.
         */
        async function deleteTodo(docId) {
            if (!db || !userId || !docId) return;

            try {
                // Get the document reference
                const todoDocRef = doc(getTodosCollectionRef(), docId);
                await deleteDoc(todoDocRef);
            } catch (error) {
                console.error("Error deleting document: ", error);
            }
        }

        /**
         * Sets up the real-time listener for the user's todos.
         */
        function setupRealtimeListener() {
            const q = getTodosCollectionRef();

            // Set up onSnapshot listener for real-time updates
            onSnapshot(q, (snapshot) => {
                const todos = [];
                snapshot.forEach((doc) => {
                    // Include the document ID for deletion later
                    todos.push({ id: doc.id, ...doc.data() });
                });

                // Sort todos by creation time (newest first)
                todos.sort((a, b) => b.createdAt - a.createdAt); 

                renderTodos(todos);
                console.log("Todos updated in real-time.");
            }, (error) => {
                console.error("Error listening to documents: ", error);
                todoListContainer.innerHTML = `<p class="text-red-500 text-center py-4">Error loading tasks: ${error.message}</p>`;
            });
        }

        /**
         * Renders the current list of todos to the DOM.
         * @param {Array<Object>} todos The list of todo objects.
         */
        function renderTodos(todos) {
            // Clear current content
            todoListContainer.innerHTML = ''; 

            if (todos.length === 0) {
                todoListContainer.innerHTML = `
                    <p class="text-gray-400 text-center py-4 transition duration-300">
                        No tasks yet. Get productive!
                    </p>`;
                return;
            }

            todos.forEach(todo => {
                const todoElement = document.createElement('div');
                todoElement.className = `
                    flex justify-between items-center p-4 rounded-xl shadow-sm 
                    bg-indigo-50 border border-indigo-200 hover:bg-indigo-100 transition duration-150
                `;
                todoElement.innerHTML = `
                    <span class="text-gray-700 text-lg font-medium select-none">${todo.task}</span>
                    <button 
                        data-id="${todo.id}" 
                        class="delete-btn bg-red-500 hover:bg-red-600 text-white p-2 rounded-full 
                                transition duration-150 transform active:scale-90"
                        aria-label="Delete task"
                    >
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                        </svg>
                    </button>
                `;
                todoListContainer.appendChild(todoElement);
            });

            // Attach event listeners to all delete buttons
            todoListContainer.querySelectorAll('.delete-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const docId = e.currentTarget.getAttribute('data-id');
                    deleteTodo(docId);
                });
            });
        }

        // --- Event Listeners ---
        addButton.addEventListener('click', addTodo);
        todoInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                addTodo();
            }
        });
        todoInput.addEventListener('input', () => {
            addButton.disabled = todoInput.value.trim() === '';
        });

        // Run the initialization sequence on window load
        window.onload = initializeFirebase;
    </script>
</body>
</html>
